
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isAuth() {
      return request.auth != null;
    }

    function isISOTimestampString(timestampStr) {
      // Basic ISO string check - more robust validation is hard in rules
      // Assumes YYYY-MM-DDTHH:MM:SS.sssZ format
      return timestampStr is string && timestampStr.matches("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?Z$");
    }

    function isValidCannabinoidProfile(profile) {
      return profile is map &&
             (!('min' in profile) || profile.min == null || profile.min is number) &&
             (!('max' in profile) || profile.max == null || profile.max is number) &&
             (!('min'in profile) || !('max' in profile) || profile.min == null || profile.max == null || profile.min <= profile.max);
    }

    // Cultivars Collection
    match /cultivars/{cultivarId} {
      allow read: if true;

      allow create: if isAuth()
        && request.resource.data.name is string && request.resource.data.name.size() > 0
        && request.resource.data.genetics is string && request.resource.data.genetics in ['Sativa', 'Indica', 'Hybrid', 'Ruderalis']
        && request.resource.data.status is string && request.resource.data.status in ['Live', 'featured', 'User Submitted', 'recentlyAdded', 'Hide', 'archived']
        && (request.resource.data.thc is map && isValidCannabinoidProfile(request.resource.data.thc))
        && (request.resource.data.cbd is map && isValidCannabinoidProfile(request.resource.data.cbd))
        && ( !('cbc' in request.resource.data) || request.resource.data.cbc == null || isValidCannabinoidProfile(request.resource.data.cbc) )
        && ( !('cbg' in request.resource.data) || request.resource.data.cbg == null || isValidCannabinoidProfile(request.resource.data.cbg) )
        && ( !('cbn' in request.resource.data) || request.resource.data.cbn == null || isValidCannabinoidProfile(request.resource.data.cbn) )
        && ( !('thcv' in request.resource.data) || request.resource.data.thcv == null || isValidCannabinoidProfile(request.resource.data.thcv) )
        && request.resource.data.effects is list
        && (request.resource.data.effects.size() == 0 || request.resource.data.effects[0] is string)
        && ( !('medicalEffects' in request.resource.data) || request.resource.data.medicalEffects == null || (request.resource.data.medicalEffects is list && (request.resource.data.medicalEffects.size() == 0 || request.resource.data.medicalEffects[0] is string)) )
        && ( !('flavors' in request.resource.data) || request.resource.data.flavors == null || (request.resource.data.flavors is list && (request.resource.data.flavors.size() == 0 || request.resource.data.flavors[0] is string)) )
        && request.resource.data.description is string
        && request.resource.data.images is list
        && (request.resource.data.images.size() == 0 || (request.resource.data.images[0] is map && request.resource.data.images[0].url is string))
        && ( !('supplierUrl' in request.resource.data) || request.resource.data.supplierUrl == null || request.resource.data.supplierUrl is string )
        && ( !('source' in request.resource.data) || request.resource.data.source == null || request.resource.data.source is string )
        && ( !('cultivationPhases' in request.resource.data) || request.resource.data.cultivationPhases == null || request.resource.data.cultivationPhases is map )
        && ( !('plantCharacteristics' in request.resource.data) || request.resource.data.plantCharacteristics == null || request.resource.data.plantCharacteristics is map )
        && ( !('pricing' in request.resource.data) || request.resource.data.pricing == null || request.resource.data.pricing is map )
        && ( !('terpeneProfile' in request.resource.data) || request.resource.data.terpeneProfile == null || (request.resource.data.terpeneProfile is list && (request.resource.data.terpeneProfile.size() == 0 || request.resource.data.terpeneProfile[0] is map)) )
        && ( !('additionalInfo' in request.resource.data) || request.resource.data.additionalInfo == null || (
            request.resource.data.additionalInfo is map &&
            ( !('geneticCertificate' in request.resource.data.additionalInfo) || request.resource.data.additionalInfo.geneticCertificate is list ) &&
            ( !('plantPicture' in request.resource.data.additionalInfo) || request.resource.data.additionalInfo.plantPicture is list ) &&
            ( !('cannabinoidInfo' in request.resource.data.additionalInfo) || request.resource.data.additionalInfo.cannabinoidInfo is list ) &&
            ( !('terpeneInfo' in request.resource.data.additionalInfo) || request.resource.data.additionalInfo.terpeneInfo is list )
          ))
        && request.resource.data.parents is list
        && request.resource.data.children is list
        && request.resource.data.reviews is list && request.resource.data.reviews.size() == 0
        && request.resource.data.history is list && request.resource.data.history.size() == 1
        && request.resource.data.history[0].timestamp is string && isISOTimestampString(request.resource.data.history[0].timestamp)
        && request.resource.data.history[0].event is string
        && request.resource.data.history[0].details is map
        && request.resource.data.createdAt == request.time
        && request.resource.data.updatedAt == request.time;

      allow update: if isAuth()
        && request.resource.data.name is string && request.resource.data.name.size() > 0
        && request.resource.data.genetics is string && request.resource.data.genetics in ['Sativa', 'Indica', 'Hybrid', 'Ruderalis']
        && request.resource.data.status is string && request.resource.data.status in ['Live', 'featured', 'User Submitted', 'recentlyAdded', 'Hide', 'archived']
        && (request.resource.data.thc is map && isValidCannabinoidProfile(request.resource.data.thc))
        && (request.resource.data.cbd is map && isValidCannabinoidProfile(request.resource.data.cbd))
        && ( !('cbc' in request.resource.data) || request.resource.data.cbc == null || isValidCannabinoidProfile(request.resource.data.cbc) )
        && ( !('cbg' in request.resource.data) || request.resource.data.cbg == null || isValidCannabinoidProfile(request.resource.data.cbg) )
        && ( !('cbn' in request.resource.data) || request.resource.data.cbn == null || isValidCannabinoidProfile(request.resource.data.cbn) )
        && ( !('thcv' in request.resource.data) || request.resource.data.thcv == null || isValidCannabinoidProfile(request.resource.data.thcv) )
        && request.resource.data.effects is list
        && (request.resource.data.effects.size() == 0 || request.resource.data.effects[0] is string)
        && ( !('medicalEffects' in request.resource.data) || request.resource.data.medicalEffects == null || (request.resource.data.medicalEffects is list && (request.resource.data.medicalEffects.size() == 0 || request.resource.data.medicalEffects[0] is string)) )
        && ( !('flavors' in request.resource.data) || request.resource.data.flavors == null || (request.resource.data.flavors is list && (request.resource.data.flavors.size() == 0 || request.resource.data.flavors[0] is string)) )
        && request.resource.data.description is string
        && request.resource.data.images is list
        && (request.resource.data.images.size() == 0 || (request.resource.data.images[0] is map && request.resource.data.images[0].url is string))
        && ( !('supplierUrl' in request.resource.data) || request.resource.data.supplierUrl == null || request.resource.data.supplierUrl is string )
        && ( !('source' in request.resource.data) || request.resource.data.source == null || request.resource.data.source is string )
        && ( !('cultivationPhases' in request.resource.data) || request.resource.data.cultivationPhases == null || request.resource.data.cultivationPhases is map )
        && ( !('plantCharacteristics' in request.resource.data) || request.resource.data.plantCharacteristics == null || request.resource.data.plantCharacteristics is map )
        && ( !('pricing' in request.resource.data) || request.resource.data.pricing == null || request.resource.data.pricing is map )
        && ( !('terpeneProfile' in request.resource.data) || request.resource.data.terpeneProfile == null || (request.resource.data.terpeneProfile is list && (request.resource.data.terpeneProfile.size() == 0 || request.resource.data.terpeneProfile[0] is map)) )
        && ( !('additionalInfo' in request.resource.data) || request.resource.data.additionalInfo == null || (
            request.resource.data.additionalInfo is map &&
            ( !('geneticCertificate' in request.resource.data.additionalInfo) || request.resource.data.additionalInfo.geneticCertificate is list ) &&
            ( !('plantPicture' in request.resource.data.additionalInfo) || request.resource.data.additionalInfo.plantPicture is list ) &&
            ( !('cannabinoidInfo' in request.resource.data.additionalInfo) || request.resource.data.additionalInfo.cannabinoidInfo is list ) &&
            ( !('terpeneInfo' in request.resource.data.additionalInfo) || request.resource.data.additionalInfo.terpeneInfo is list )
          ))
        && request.resource.data.parents is list
        && request.resource.data.children is list
        // Validation for reviews (arrayUnion)
        && request.resource.data.reviews is list
        && (request.resource.data.reviews.size() == resource.data.reviews.size() || request.resource.data.reviews.size() == resource.data.reviews.size() + 1)
        && (request.resource.data.reviews.size() == 0 || (request.resource.data.reviews[0] is map && request.resource.data.reviews[0].text is string)) // Basic check on first item if not empty
        // Validation for history (arrayUnion)
        && request.resource.data.history is list
        && (request.resource.data.history.size() == resource.data.history.size() || request.resource.data.history.size() == resource.data.history.size() + 1)
        && (request.resource.data.history.size() == 0 || (request.resource.data.history[0] is map && request.resource.data.history[0].event is string)) // Basic check
        && request.resource.data.createdAt == resource.data.createdAt // Ensure createdAt is not changed
        && request.resource.data.updatedAt == request.time; // Ensure updatedAt is a server timestamp

      allow delete: if false; // Or define your delete rules, e.g., if isAuth() && resource.data.status == 'archived';
    }

    // Submitted Cultivars Collection (for user submissions)
    match /submitted_cultivars/{submissionId} {
      allow read: if isAuth(); // Only authenticated users (admins) can read submissions for review
      allow create: if true; // Allow anyone to submit a cultivar for review
                           // No update/delete for now by clients, handled by admin process
      allow update: if isAuth(); // Admins might update status to 'reviewed', 'rejected' etc.
      allow delete: if isAuth(); // Admins can delete submissions
    }
  }
}

    